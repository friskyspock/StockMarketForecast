{% extends 'base.html' %}
{% block content %}

<div class="container-fluid vh-100">

    <div class="row">
        <div class="d-flex justify-content-sm-start">
            <h1 class="display-6">{{ name }}</h1>
        </div>
    </div>
    
    <div class="row justify-content-start">
        <div class="p-3 my-3 bg-info bg-opacity-10 border border-info rounded">
            <div class="overflow-x-scroll" style="max-width: 100%;">
                <div class="containerBody" style="width: 12000px;">
                    <canvas id="myChart" height="600"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="p-3 my-3 bg-info bg-opacity-10 border border-info rounded">
            <canvas id="myChart2" height="60"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    async function fetchData() {
    const response = await fetch("{% url 'send_data' %}");
    const datapoints = await response.json();
    return datapoints;
    };
</script>

<!--CandleStick-->
<script>
    fetchData().then(datapoints => {
        const dataset = datapoints.map(function(index){return {x:index.Date,o:index.Open,h:index.High,l:index.Low,c:index.Close,s:[index.Open,index.Close]}})
        myChart.data.datasets[0].data = dataset;
        myChart.update();
    });
    // setup
    const data = {
      datasets: [{
        label: "Last 30 days",
        data: [{x: new Date('2022-06-04').setHours(0,0,0,0),
                o: 1.50,
                h: 1.80,
                l: 1.20,
                c: 1.40,
                s: [1.50, 1.40]}],
        //data: [{% for row in last_month_data%}{x:'{{ row.Date }}',o:'{{ row.Open }}',h:'{{ row.High }}',l:'{{ row.Low }}',c:'{{ row.Close }}',s: ['{{ row.Open }}','{{ row.Close }}'] },{% endfor %}],
        backgroundColor: (ctx) => {
            const { raw: {o, c} } = ctx;
            let color;
            if(c >= o) {
                color = 'rgba(75, 192, 192, 1)';
            } else {
                color = 'rgba(255, 26, 104, 1)';
            }
            return color;
        },
        borderColor: 'rgba(0, 0, 0, 1)',
        borderWidth: 1,
        borderSkipped: false,
      }]
    };

    // candlestick plugin block
    const candlestick = {
        id: 'candlestick',
        beforeDatasetsDraw(chart, args, pluginOptions) {
            const { ctx, data, chartArea: { top, bottom, left, right, width, height }, scales: {x,y}} = chart;

            ctx.save();
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(255,255,255,1)';
            
            data.datasets[0].data.forEach((datapoint, index) => {
                ctx.beginPath();
                ctx.moveTo(chart.getDatasetMeta(0).data[index].x, chart.getDatasetMeta(0).data[index].y);
                ctx.lineTo(chart.getDatasetMeta(0).data[index].x, y.getPixelForValue(data.datasets[0].data[index].h));
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(chart.getDatasetMeta(0).data[index].x, chart.getDatasetMeta(0).data[index].y);
                ctx.lineTo(chart.getDatasetMeta(0).data[index].x, y.getPixelForValue(data.datasets[0].data[index].l));
                ctx.stroke();
            })
        }
    }

    // config 
    const config = {
      type: 'bar',
      data,
      options: {
        legend: {
            display: false,
        },
        parsing: {
            xAxisKey: 'x',
            yAxisKey: 's',
        },
        maintainAspectRatio: false,
        scales: {
        x: {
            type: 'time',
            time: {
                unit: 'week',
            }
            },
        y: {
            beginAtZero: false,
          }
        }
      },
      plugins: [candlestick]
    };

    // render init block
    const myChart = new Chart(
      document.getElementById('myChart'),
      config
    );

    // Instantly assign Chart.js version
    //const chartVersion = document.getElementById('chartVersion');
    //chartVersion.innerText = Chart.version;
</script>

<!--LinePlot-->
<script>
    fetchData().then(datapoints => {
        const dataset2 = datapoints.map(function(index){return {x:index.Date,y:index.Close}})
        myChart2.config.data.datasets[0].data = dataset2;
        myChart2.update();
    });
    // data
    const data2 = {
        datasets: [{
            label: 'Close value',
            fill: true,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1,
            pointRadius: 0
        }]
        };

    // config
    const config2 = {
        type: 'line',
        data: data2,
        options: {
            plugins: {
                legend: {
                    labels: {
                        color: 'rgb(255,255,255)',
                    },
                },
            },
            scales: {
                x: {
                    type:'time',
                    time: {unit:'year'},
                    grid: {color:'rgba(161,161,161,0.1)'},
                    ticks: {color: 'rgb(255,255,255)'},
                },
                y: {
                    beginAtZero: true,
                    grid: {color:'rgba(161,161,161,0.1)'},
                    ticks: {color: 'rgb(255,255,255)'},
                }
            }, 
            layout: {padding: 20}
        }
    };

     // render init block
    const myChart2 = new Chart(
      document.getElementById('myChart2'),
      config2
    );
</script>

{% endblock content %}